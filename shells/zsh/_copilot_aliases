#compdef cpcommit cppush cppull cprevert cpbranch cplog cpstatus cppr cpprs cpissue cpissues cpmerge cpreview cptest cpfix cpbuild cpexplain cpdocs cprefactor cphelp cpdebug cpoptimize

# Zsh completion function for Awesome Copilot CLI Aliases

_copilot_aliases() {
    local -a commands
    commands=(
        'cpcommit:Commit with AI or custom message'
        'cppush:Push to remote'
        'cppull:Pull from remote'
        'cprevert:Revert commit'
        'cpbranch:Create new branch'
        'cplog:Show git log with summaries'
        'cpstatus:Summarize git status'
        'cppr:Create or view PR'
        'cpprs:List open PRs'
        'cpissue:Create or view issue'
        'cpissues:List your issues'
        'cpmerge:Merge PR'
        'cpreview:Review PR'
        'cptest:Run tests'
        'cpfix:Fix linting issues'
        'cpbuild:Build project'
        'cpexplain:Explain code'
        'cpdocs:Generate docs'
        'cprefactor:Suggest refactoring'
        'cphelp:Show help'
        'cpdebug:Debug current issue'
        'cpoptimize:Suggest optimizations'
    )

    local curcontext="$curcontext" state line
    typeset -A opt_args

    case "$service" in
        cpcommit)
            _message 'commit message (optional)'
            ;;
        cppush|cppull|cplog|cpstatus|cpprs|cpissues|cpbuild|cphelp|cpdebug|cpoptimize)
            # No parameters needed
            ;;
        cprevert)
            _alternative \
                'commits:commit hash:_git_commits' \
                'refs:commit ref:(HEAD HEAD~1 HEAD~2)'
            ;;
        cpbranch)
            _message 'branch name (optional - AI will suggest if omitted)'
            ;;
        cppr|cpissue)
            if (( CURRENT == 2 )); then
                _message 'PR/issue number (optional)'
                # Try to complete with actual PR/issue numbers
                if (( $+commands[gh] )); then
                    local -a prs
                    prs=(${(f)"$(gh pr list --json number,title --jq '.[] | "\(.number):\(.title)"' 2>/dev/null)"})
                    if (( ${#prs} > 0 )); then
                        _describe 'pull request' prs
                    fi
                fi
            fi
            ;;
        cpmerge|cpreview)
            if (( CURRENT == 2 )); then
                _message 'PR number (required)'
                # Try to complete with actual PR numbers
                if (( $+commands[gh] )); then
                    local -a prs
                    prs=(${(f)"$(gh pr list --json number,title --jq '.[] | "\(.number):\(.title)"' 2>/dev/null)"})
                    if (( ${#prs} > 0 )); then
                        _describe 'pull request' prs
                    fi
                fi
            fi
            ;;
        cptest)
            _message 'test pattern (optional)'
            _files -g '*.test.* *.spec.*'
            ;;
        cpexplain|cpfix|cpdocs|cprefactor)
            _files
            ;;
        cp)
            _describe 'copilot alias' commands
            ;;
    esac
}

# Helper function for git commits
_git_commits() {
    if (( $+commands[git] )); then
        local -a commits
        commits=(${(f)"$(git log --oneline -n 20 --format='%h:%s' 2>/dev/null)"})
        _describe 'commit' commits
    fi
}

# Register the completion function
_copilot_aliases "$@"

# Also provide completion when user types 'cp' to list all aliases
compdef _copilot_aliases cp
